<div id="form-container"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getFirestore, doc, getDoc, addDoc, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCWH18dhHz0EBY5Ycc4wjZ1H6AlO-51sho",
  authDomain: "teste1-66092.firebaseapp.com",
  projectId: "teste1-66092",
  storageBucket: "teste1-66092.appspot.com",
  messagingSenderId: "517435649522",
  appId: "1:517435649522:web:a6826c13b1e2c5062acf6b",
  measurementId: "G-3GVBBV8W7C"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const container = document.getElementById('form-container');

async function carregarCodigo() {
  const snap = await getDoc(doc(db,'codigos','codigoUsuario'));
  return snap.exists() ? (snap.data().conteudo || '') : '';
}

function criarFormulario(codigo) {
  container.innerHTML='';
  const form = document.createElement('form');
  form.id='formulario';
  
  // Captura blocos [formulário]
  const regexForm = /\[formulário\]([\s\S]*?)\[formulário\]/gi;
  const match = regexForm.exec(codigo);
  if(!match) { container.innerText='Nenhum bloco [formulário] encontrado.'; return; }
  
  const linhas = match[1].split('\n').map(l=>l.trim()).filter(Boolean);

  for(let i=0;i<linhas.length;i+=3) {
    const label = linhas[i].replace(/^\[:|:\]$/g,'');
    const inputLinha = linhas[i+1];
    const tipo = linhas[i+2].match(/^\[:tipo-(.+?):\]$/i);

    const inputLabel = inputLinha.match(/^\[:input:\s*(.+?)\]/i);
    const obrigatorio = /\[Ação:obrigatório\]/i.test(inputLinha);

    if(inputLabel && tipo) {
      const lbl = document.createElement('label');
      lbl.textContent=label + (obrigatorio ? ' *' : '');
      const input = document.createElement('input');
      input.name=label;
      input.placeholder=inputLabel[1];
      input.type= tipo[1]==='numero' ? 'number' : 'text';
      if(obrigatorio) input.dataset.obrigatorio = "true";

      form.appendChild(lbl);
      form.appendChild(input);
      form.appendChild(document.createElement('br'));
    }
  }

  // Captura bloco [função] para botão
  const regexFunc = /\[função\]([\s\S]*?)\[função\]/gi;
  const matchFunc = regexFunc.exec(codigo);
  if(matchFunc) {
    const btnMatch = matchFunc[1].match(/\[botão-publicar:\s*(.+?)\]/i);
    const msgMatch = matchFunc[1].match(/\[mensagem:\s*(.+?)\]/i);

    if(btnMatch) {
      const btn = document.createElement('button');
      btn.type='button';
      btn.textContent=btnMatch[1];
      btn.addEventListener('click', async ()=>{
        let erro=false;
        const dados = {};

        for(let el of form.elements){
          if(el.name){
            if(el.dataset.obrigatorio === "true" && el.value.trim() === ""){
              el.style.border = "2px solid red";
              erro=true;
            } else {
              el.style.border = "";
              dados[el.name]=el.value;
            }
          }
        }

        if(erro){
          alert('⚠️ Preencha todos os campos obrigatórios!');
          return;
        }

        try{
          await addDoc(collection(db,'anuncios'), {...dados, criadoEm:serverTimestamp()});
          alert(msgMatch ? msgMatch[1] : 'Dados enviados com sucesso!');
          form.reset();
        }catch(err){
          alert('Erro ao enviar: '+err.message);
        }
      });
      form.appendChild(btn);
    }
  }

  container.appendChild(form);
}

// Carrega o código do Firestore e cria o formulário
carregarCodigo().then(codigo => criarFormulario(codigo));
</script>
