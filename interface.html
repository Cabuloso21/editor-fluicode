 <!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>pagi 2</title>
</head>
<body>

<div id="container"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import {
    getFirestore, doc, getDoc
  } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

  // Config Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyCWH18dhHz0EBY5Ycc4wjZ1H6AlO-51sho",
    authDomain: "teste1-66092.firebaseapp.com",
    projectId: "teste1-66092",
    storageBucket: "teste1-66092.firebasestorage.app",
    messagingSenderId: "517435649522",
    appId: "1:517435649522:web:a6826c13b1e2c5062acf6b",
    measurementId: "G-3GVBBV8W7C"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const container = document.getElementById('container');

  // Regex para capturar blocos e campos
  const pagmentBlockRegex = /\[pagment\]([\s\S]*?)\[pagment\]/gi;
  const funcBlockRegex = /\[função\]([\s\S]*?)\[função\]/gi;
  const fieldRegex = /^\[:([\p{L}\p{N}_-]+):\s*(.*?)\s*\]$/u;
  const funcButtonRegex = /^\[botão:\s*(.+?):\s*direct link:(https?:\/\/[^\]\s]+)\]$/iu;

  async function carregarCodigo() {
    try {
      const docRef = doc(db, 'codigos', 'codigoUsuario');
      const snap = await getDoc(docRef);
      if (!snap.exists()) {
        container.innerHTML = '<p>❌ Nenhum código encontrado.</p>';
        return;
      }

      const conteudo = snap.data().conteudo || '';
      renderizarInterface(conteudo);

    } catch (err) {
      container.innerHTML = `<p>Erro ao carregar: ${err.message || err}</p>`;
    }
  }

  function renderizarInterface(codigo) {
    container.innerHTML = '';

    // Extrair blocos pagment e função, assumindo que estão pareados na ordem
    const pagments = [...codigo.matchAll(pagmentBlockRegex)];
    const funcoes = [...codigo.matchAll(funcBlockRegex)];

    // Percorrer todos os blocos pagment
    pagments.forEach((pagmentMatch, i) => {
      const pagmentText = pagmentMatch[1];
      const campos = pagmentText.split('\n').map(l => l.trim()).filter(l => l.length);

      const pagmentDiv = document.createElement('div');
      pagmentDiv.className = 'pagment';
      pagmentDiv.style.border = '1px solid #ccc';
      pagmentDiv.style.padding = '10px';
      pagmentDiv.style.margin = '10px 0';
      pagmentDiv.style.borderRadius = '8px';
      pagmentDiv.style.background = '#f8f8f8';

      // Renderizar campos do pagment (produto, valor, tipo, código, etc)
      campos.forEach(linha => {
        const m = linha.match(fieldRegex);
        if (m) {
          const campoEl = document.createElement('p');
          campoEl.innerHTML = `<strong>${capitalize(m[1])}:</strong> ${m[2]}`;
          pagmentDiv.appendChild(campoEl);
        }
      });

      // Buscar função correspondente para esse pagment (mesmo índice)
      const funcMatch = funcoes[i];
      if (funcMatch) {
        const funcText = funcMatch[1];
        const funcLines = funcText.split('\n').map(l => l.trim()).filter(l => l.length);

        funcLines.forEach(fl => {
          const btnMatch = fl.match(funcButtonRegex);
          if (btnMatch) {
            const nomeBotao = btnMatch[1];
            const link = btnMatch[2];
            const botao = document.createElement('a');
            botao.href = link;
            botao.target = '_blank';
            botao.textContent = nomeBotao;
            botao.style.display = 'inline-block';
            botao.style.padding = '8px 12px';
            botao.style.background = '#007bff';
            botao.style.color = '#fff';
            botao.style.textDecoration = 'none';
            botao.style.borderRadius = '5px';
            botao.style.marginTop = '10px';
            pagmentDiv.appendChild(botao);
          }
        });
      }

      container.appendChild(pagmentDiv);
    });
  }

  function capitalize(str) {
    if (!str) return '';
    return str.charAt(0).toUpperCase() + str.slice(1);
  }

  carregarCodigo();
</script>

